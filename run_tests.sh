#!/bin/bash

# 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
TIMESTAMP=$(date +%Y%m%d_%H%M)
REPORT_NAME="report_$TIMESTAMP.html"
REPORT_PATH="tests_reports/$REPORT_NAME"

# 2. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫—ç—à–∏ Python (–≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤)
find . -name "__pycache__" -type d -exec rm -rf {} +

echo "------------------------------------------------"
echo "Ì∫Ä –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤: $REPORT_NAME"
echo "------------------------------------------------"

# 3. –ó–∞–ø—É—Å–∫ pytest —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ—Ä–Ω—è –∏ –ø—É—Ç–µ–π
# --rootdir . : –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ
# -v : –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏
# --self-contained-html : –≤—à–∏–≤–∞–µ—Ç CSS/JS –ø—Ä—è–º–æ –≤ HTML
pytest --rootdir . -v --html="$REPORT_PATH" --self-contained-html

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–æ–∑–¥–∞–ª—Å—è –ª–∏ —Ñ–∞–π–ª –∏ –Ω–µ –ø—É—Å—Ç–æ–π –ª–∏ –æ–Ω
if [ -f "$REPORT_PATH" ]; then
    SIZE=$(du -h "$REPORT_PATH" | cut -f1)
    echo "‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $REPORT_PATH (–†–∞–∑–º–µ—Ä: $SIZE)"
    echo "------------------------------------------------"
else
    echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª –æ—Ç—á–µ—Ç–∞ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!"
fi
